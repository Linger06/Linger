@page "/textfield-navigation"
@attribute [AllowAnonymous]

<PageTitle>TextField 键盘导航测试</PageTitle>

<MudContainer Class="mt-4">
    <MudCard Elevation="4">
        <MudCardHeader>
            <MudText Typo="Typo.h5">TextField 回车键导航测试</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudText Class="mb-4">按回车键可以在字段之间跳转。最后一个字段按回车会触发提交操作。</MudText>

            <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
                <MudItem md="3" sm="4">
                    <MudTextField @ref="_field1"
                                  T="string"
                                  Label="姓名"
                                  @bind-Value="_name"
                                  Required="true"
                                  RequiredError="姓名是必填项"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  AutoFocus="true"
                                  OnKeyDown="@(e => HandleKeyDown(e, 1))" />

                    <MudTextField @ref="_field2"
                                  T="string"
                                  Label="电话"
                                  @bind-Value="_phone"
                                  Required="true"
                                  RequiredError="电话是必填项"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  OnKeyDown="@(e => HandleKeyDown(e, 2))" />

                    <MudTextField @ref="_field3"
                                  T="string"
                                  Label="邮箱"
                                  @bind-Value="_email"
                                  Required="true"
                                  RequiredError="邮箱是必填项"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  OnKeyDown="@(e => HandleKeyDown(e, 3))" />

                    <MudTextField @ref="_field4"
                                  T="string"
                                  Label="地址"
                                  @bind-Value="_address"
                                  Required="true"
                                  RequiredError="地址是必填项"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  OnKeyDown="@(e => HandleKeyDown(e, 4))" />
                </MudItem>
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="Submit"
                       Disabled="@(!_formIsValid)">提交</MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="Reset">重置</MudButton>
        </MudCardActions>
    </MudCard>

    @if (_showResult)
    {
        <MudCard Elevation="4" Class="mt-4">
            <MudCardHeader>
                <MudText Typo="Typo.h6">提交结果</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudText><strong>姓名:</strong> @_name</MudText>
                <MudText><strong>电话:</strong> @_phone</MudText>
                <MudText><strong>邮箱:</strong> @_email</MudText>
                <MudText><strong>地址:</strong> @_address</MudText>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private MudForm _form;
    private MudTextField<string> _field1;
    private MudTextField<string> _field2;
    private MudTextField<string> _field3;
    private MudTextField<string> _field4;

    private string _name = string.Empty;
    private string _phone = string.Empty;
    private string _email = string.Empty;
    private string _address = string.Empty;

    private bool _formIsValid;
    private bool _showResult;
    
    // 聚焦到第一个字段并选中文本
    private async Task FocusFirstField()
    {
        if (_field1 != null)
        {
            await _field1.FocusAsync();
            await _field1.SelectAsync();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e, int fieldNumber)
    {
        if (e.Key == "Enter")
        {
            switch (fieldNumber)
            {
                case 1:
                    await _field2.FocusAsync();
                    await _field2.SelectAsync();
                    break;
                case 2:
                    await _field3.FocusAsync();
                    await _field3.SelectAsync();
                    break;
                case 3:
                    await _field4.FocusAsync();
                    await _field4.SelectAsync();
                    break;
                case 4:
                    if (_formIsValid)
                    {
                        await Submit();
                    }
                    break;
            }
        }
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_formIsValid)
        {
            _showResult = true;
            StateHasChanged();
        }
    }

    private async Task Reset()
    {
        _name = string.Empty;
        _phone = string.Empty;
        _email = string.Empty;
        _address = string.Empty;
        _showResult = false;
        await _form.ResetAsync();
        
        // 重置后再次聚焦到第一个字段
        await FocusFirstField();
        
        StateHasChanged();
    }
}